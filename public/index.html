<!DOCTYPE html>
<html>
  <head>
    <title>Tic Tac Toe</title>
    <script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
    <script src="script.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.1.0/dist/aframe-environment-component.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v6.0.0/dist/aframe-extras.loaders.min.js"></script>
  </head>

  <body onload="resetBoard()">
    <a-scene>
      <a-assets>
        <a-asset-item id="tank" src="/assets/cartoon_wood_tank/scene.gltf" />
      </a-assets>

      <a-entity environment="preset: forest; groundColor: #445; skyColor: #000"></a-entity>

      <a-entity position="0 0 1.5">
        <a-camera> <a-cursor> </a-cursor> </a-camera>
      </a-entity>

      <a-entity
        position="2.8 3 -1"
        id="winner"
        text="value:Make your move!; color:black"
        height="1.5"
        width="4"
        scale="10 10 10"
      ></a-entity>
      <!--top row-->
      <a-box
        color="tomato"
        position="-1 2.5 -2"
        height="0.5"
        width="0.5"
        depth="0.5"
        onclick="clicked('0,0')"
        id="0,0"
        animation="property: rotation; startEvents: click; from: 0 0 0; to: 360 90 90; dur: 1000"
      ></a-box>
      <a-box
        color="tomato"
        position="0 2.5 -2"
        height="0.5"
        width="0.5"
        depth="0.5"
        onclick="clicked('0,1')"
        id="0,1"
        animation="property: rotation; startEvents: click; from: 0 0 0; to: 360 90 90; dur: 1000"
      ></a-box>
      <a-box
        color="tomato"
        position="1 2.5 -2"
        height="0.5"
        width="0.5"
        depth="0.5"
        onclick="clicked('0,2')"
        id="0,2"
        animation="property: rotation; startEvents: click; from: 0 0 0; to: 360 90 90; dur: 1000"
      ></a-box>
      <!--middle row-->
      <a-box
        color="tomato"
        position="-1 1.5 -2"
        height="0.5"
        width="0.5"
        depth="0.5"
        onclick="clicked('1,0')"
        id="1,0"
        animation="property: rotation; startEvents: click; from: 0 0 0; to: 360 90 90; dur: 1000"
      ></a-box>
      <a-box
        color="tomato"
        position="0 1.5 -2"
        height="0.5"
        width="0.5"
        depth="0.5"
        onclick="clicked('1,1')"
        id="1,1"
        animation="property: rotation; startEvents: click; from: 0 0 0; to: 360 90 90; dur: 1000"
      ></a-box>
      <a-box
        color="tomato"
        position="1 1.5 -2"
        height="0.5"
        width="0.5"
        depth="0.5"
        onclick="clicked('1,2')"
        id="1,2"
        animation="property: rotation; startEvents: click; from: 0 0 0; to: 360 90 90; dur: 1000"
      ></a-box>
      <!--bottom row-->
      <a-box
        color="tomato"
        position="-1 0.5 -2"
        height="0.5"
        width="0.5"
        depth="0.5"
        onclick="clicked('2,0')"
        id="2,0"
        animation="property: rotation; startEvents: click; from: 0 0 0; to: 360 90 90; dur: 1000"
      ></a-box>
      <a-box
        color="tomato"
        position="0 0.5 -2"
        height="0.5"
        width="0.5"
        depth="0.5"
        onclick="clicked('2,1')"
        id="2,1"
        animation="property: rotation; startEvents: click; from: 0 0 0; to: 360 90 90; dur: 1000"
      ></a-box>
      <a-box
        color="tomato"
        position="1 0.5 -2"
        height="0.5"
        width="0.5"
        depth="0.5"
        onclick="clicked('2,2')"
        id="2,2"
        animation="property: rotation; startEvents: click; from: 0 0 0; to: 360 90 90; dur: 1000"
      ></a-box>

      <a-entity
        gltf-model="#tank"
        position="3 0.5 -1.5"
        scale="0.4 0.4 0.4"
	animation-mixer
      >
      </a-entity>

      <a-light id="animated-light" type="point" intensity=".8" position="0 6 6" />
    </a-scene>
    <audio id="soundtrack" src="assets/video-game-blockbuster.mp3" autoplay loop></audio>
    <script>
      (function() {
        console.log('starting audio context')
        const context = new AudioContext();
        let maxAmp = 0.5;
        let minAmp = 0.3;

        // Here's where most of the work happens
        function processAudio(e) {

          console.log('processAudio')
          const light = document.getElementById('animated-light');
          const buffer = e.inputBuffer.getChannelData(0);
          const out = e.outputBuffer.getChannelData(0);
          let amp = 0;

          // Iterate through buffer to get the max amplitude for this frame
          for (let i = 0; i < buffer.length; i++) {
            const loud = Math.abs(buffer[i]);
            if(loud > amp) {
              amp = loud;
            }
            // write input samples to output unchanged
            out[i] = buffer[i];
          }
          //minAmp = Math.min(minAmp, amp);
          //maxAmp = Math.max(maxAmp, amp);
          const scaledAmp = (amp - minAmp) / (maxAmp - minAmp);
          light.setAttribute('intensity', scaledAmp);
          console.log('amplitude ' + amp + ' scaled ' + scaledAmp);
        }

        window.addEventListener('load',function() {
          console.log('adding audio listeners')
          // Add an audio element
          const audio = document.getElementById('soundtrack');


          //audio.addEventListener('canplaythrough',function() {
            console.log('audio canplaythrough')
            const node = context.createMediaElementSource(audio);

            // create a node that will handle the animation, but won't alter the audio
            // in any way
            const processor = context.createScriptProcessor(0,1,1);
            processor.onaudioprocess = processAudio;

            // connect the audio element to the node responsible for the animation
            node.connect(processor);

            // connect the "animation" node to the output
            processor.connect(context.destination);

            // play the sound
            audio.play();
          //});
        });
      })();
    </script>
  </body>
</html>
